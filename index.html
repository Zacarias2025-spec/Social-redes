<!--
  Esfera Conectada - Single-file web app (HTML + JS + CSS)
  Instru√ß√µes r√°pidas:
  1) Substitua SUPABASE_URL e SUPABASE_ANON_KEY abaixo OU configure como vari√°veis de ambiente no deploy (recomendado).
  2) Crie as tabelas no Supabase com o SQL do README.
  3) Crie buckets: avatars, post_media, message_files
  4) Deploy no Vercel (static).
-->

<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Esfera Conectada</title>
  <meta name="description" content="Esfera Conectada - Rede social leve e em tempo real (exemplo)" />
  <style>
    /* Minimal styling, leve e responsivo */
    :root{
      --primary:#07689f; --accent:#2a9d8f; --muted:#666;
      --bg:#f7fafc; --card:#fff; --danger:#e63946;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:#0b2239}
    header{background:linear-gradient(90deg,var(--primary),#0b6b8a);color:white;padding:12px 16px;display:flex;align-items:center;gap:12px}
    header h1{margin:0;font-size:18px}
    .container{max-width:1000px;margin:18px auto;padding:0 12px}
    .card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 1px 4px rgba(2,6,23,0.06);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:12px}
    .feed .post{padding:12px;border-radius:8px;margin-bottom:10px;background:#fff}
    .small{font-size:13px;color:var(--muted)}
    input,textarea,select,button{font:inherit}
    input,textarea,select{padding:8px;border-radius:8px;border:1px solid #e6eef2;width:100%;box-sizing:border-box}
    button{background:var(--primary);color:white;padding:8px 12px;border-radius:8px;border:0;cursor:pointer}
    .row{display:flex;gap:8px;align-items:center}
    .avatar{width:48px;height:48px;border-radius:50%;object-fit:cover;background:#ddd}
    .username{color:var(--muted);font-size:13px}
    nav a{color:white;text-decoration:none;margin-right:8px;font-size:14px}
    .profile-header{display:flex;gap:12px;align-items:center}
    .bell{cursor:pointer;margin-left:auto}
    .online-dot{width:10px;height:10px;border-radius:50%;background:#2ecc71;display:inline-block;margin-left:6px}
    .muted{color:#666;font-size:13px}
    .actions{display:flex;gap:6px}
    .notif{background:#fff;color:#000;padding:8px;border-radius:8px;margin-bottom:6px}
    .chat-list{max-height:300px;overflow:auto}
    .media-preview{max-width:100%;height:auto;border-radius:8px}
    .link{color:var(--primary);text-decoration:underline;cursor:pointer}
    footer{padding:12px;text-align:center;color:var(--muted);font-size:12px}
    /* responsive */
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/favicon.ico" alt="" style="width:28px;height:28px;border-radius:6px;background:#fff;margin-right:6px"/>
    <h1>Esfera Conectada</h1>
    <nav style="margin-left:12px">
      <a href="#" id="link-feed">Feed</a>
      <a href="#" id="link-profile">Meu Perfil</a>
      <a href="#" id="link-messages">Mensagens</a>
    </nav>
    <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
      <div id="auth-area"></div>
    </div>
  </header>

  <div class="container">
    <div id="app">

      <!-- Authentication card -->
      <div id="auth-card" class="card">
        <div id="auth-forms">
          <h3>Entrar ou Registrar</h3>
          <div id="login-form" class="card">
            <h4>Entrar</h4>
            <input id="login-email" placeholder="Email" />
            <input id="login-password" type="password" placeholder="Senha" />
            <div class="row">
              <button id="btn-login">Entrar</button>
              <button id="btn-show-register" style="background:#2a9d8f">Registrar</button>
              <button id="btn-recover" style="background:#ff9800">Recuperar senha</button>
            </div>
          </div>

          <div id="register-form" class="card" style="display:none">
            <h4>Registrar</h4>
            <input id="reg-email" placeholder="Email" />
            <input id="reg-password" type="password" placeholder="Senha" />
            <input id="reg-password2" type="password" placeholder="Reconfirmar Senha" />
            <input id="reg-display" placeholder="Nome de exibi√ß√£o" />
            <input id="reg-username" placeholder="Nome de usu√°rio (sem @)" />
            <div class="row">
              <button id="btn-register">Criar conta</button>
              <button id="btn-cancel-register" style="background:#999">Cancelar</button>
            </div>
          </div>

          <div id="recover-form" class="card" style="display:none">
            <h4>Recuperar senha</h4>
            <input id="rec-email" placeholder="Email" />
            <div class="row">
              <button id="btn-send-recover">Enviar email de recupera√ß√£o</button>
              <button id="btn-cancel-recover" style="background:#999">Cancelar</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Main grid: Feed + Right column -->
      <div class="grid">
        <div>
          <!-- Create post -->
          <div id="create-post" class="card" style="display:none">
            <h3>Novo Post</h3>
            <textarea id="post-text" rows="4" placeholder="O que voc√™ quer compartilhar?"></textarea>
            <input id="post-media" type="file" accept="image/*,audio/*,video/*" />
            <div class="row" style="margin-top:8px">
              <button id="btn-post">Publicar</button>
              <button id="btn-clear-post" style="background:#999">Limpar</button>
            </div>
            <div class="small">Aceita imagens, v√≠deos curtos, √°udios (max 3MB). Links do YouTube / TikTok ser√£o embedados.</div>
          </div>

          <!-- Feed -->
          <div id="feed" class="card feed">
            <h3>Feed</h3>
            <div id="posts-list" class="column"></div>
            <div id="no-posts" class="small" style="display:none">Nenhum post ainda.</div>
          </div>
        </div>

        <aside>
          <div class="card">
            <h4>Meu Perfil (r√°pido)</h4>
            <div id="mini-profile" class="profile-header">
              <img id="mini-avatar" class="avatar" src="" />
              <div>
                <div id="mini-display" style="font-weight:600"></div>
                <div id="mini-username" class="username"></div>
              </div>
            </div>
            <div style="margin-top:8px">
              <button id="btn-edit-profile">Editar Perfil</button>
              <button id="btn-logout" style="background:#e74c3c">Sair</button>
            </div>
          </div>

          <div id="notifications" class="card">
            <h4>Notifica√ß√µes</h4>
            <div id="notif-list"></div>
            <div style="margin-top:6px">
              <button id="btn-clear-notifs" style="background:#999">Limpar notifica√ß√µes lidas</button>
            </div>
          </div>

          <div class="card">
            <h4>Conversas</h4>
            <div class="chat-list" id="chat-list"></div>
          </div>

          <div class="card">
            <h4>Buscar usu√°rios</h4>
            <input id="search-user" placeholder="Buscar por nome ou @usuario" />
            <div id="search-results"></div>
          </div>
        </aside>
      </div>

      <!-- Profile full page modal -->
      <div id="profile-page" class="card" style="display:none">
        <div style="display:flex;align-items:center;gap:12px">
          <img id="profile-avatar" class="avatar" src="" />
          <div>
            <div style="font-weight:700" id="profile-display-full"></div>
            <div class="username" id="profile-username-full"></div>
            <div class="small" id="profile-bio"></div>
            <div class="small" id="profile-meta"></div>
          </div>
          <div style="margin-left:auto" class="row">
            <button id="btn-follow" class="bell">üîî <span id="fcount">0</span></button>
            <button id="btn-message" style="background:#2a9d8f">Mensagem</button>
            <button id="btn-block-user" style="background:#e74c3c">Bloquear</button>
          </div>
        </div>

        <div style="margin-top:12px">
          <h4>Publica√ß√µes</h4>
          <div id="profile-posts"></div>
        </div>
      </div>

      <!-- Chat modal -->
      <div id="chat-page" class="card" style="display:none">
        <div style="display:flex;gap:12px;align-items:center">
          <div>
            <img id="chat-avatar" class="avatar" src="" />
          </div>
          <div>
            <div id="chat-name" style="font-weight:700"></div>
            <div class="small" id="chat-username"></div>
          </div>
          <div style="margin-left:auto" class="row">
            <div id="chat-online" class="small muted"></div>
            <button id="btn-chat-back" style="background:#999">Voltar</button>
          </div>
        </div>

        <div id="chat-messages" style="height:320px;overflow:auto;border-radius:8px;padding:8px;margin-top:8px;background:#f6f9fb"></div>

        <div style="margin-top:8px">
          <textarea id="chat-input" rows="3" placeholder="Escreva uma mensagem... (Quebras de linha preservadas)"></textarea>
          <input id="chat-file" type="file" />
          <div class="row" style="margin-top:8px">
            <button id="btn-send-chat">Enviar</button>
            <button id="btn-edit-chat" style="display:none;background:#ff9800">Salvar edi√ß√£o</button>
            <button id="btn-cancel-edit" style="display:none;background:#999">Cancelar</button>
          </div>
          <div class="small">Voc√™ pode editar uma mensagem somente se ainda n√£o for visualizada pelo destinat√°rio.</div>
        </div>

      </div>

      <!-- Post page -->
      <div id="post-page" class="card" style="display:none">
        <div id="post-content-area"></div>
        <div style="margin-top:8px">
          <button id="btn-back-feed" style="background:#999">Voltar</button>
        </div>
      </div>

      <!-- Profile edit modal -->
      <div id="profile-edit" class="card" style="display:none">
        <h3>Editar Perfil</h3>
        <input id="edit-display" placeholder="Nome de exibi√ß√£o" />
        <input id="edit-username" placeholder="Nome de usu√°rio (√∫nico)" />
        <input id="edit-location" placeholder="Localiza√ß√£o" />
        <input id="edit-contact" placeholder="Contacto" />
        <input id="edit-education" placeholder="Forma√ß√£o acad√©mica" />
        <textarea id="edit-bio" rows="3" placeholder="Biografia"></textarea>
        <input id="edit-avatar" type="file" accept="image/*" />
        <select id="edit-lang">
          <option value="pt">Portugu√™s</option>
          <option value="en">Ingl√™s</option>
          <option value="es">Espanhol</option>
        </select>
        <div class="row" style="margin-top:8px">
          <button id="btn-save-profile">Salvar</button>
          <button id="btn-cancel-profile" style="background:#999">Cancelar</button>
        </div>
      </div>

    </div>

    <footer>Esfera Conectada ‚Äî demo. Configure Supabase e proteja dados antes de usar em produ√ß√£o.</footer>
  </div>

<script type="module">
  // Substitua com suas vari√°veis de ambiente/recomende usar em Vercel:
  // Prefer√≠vel: defina NEXT_PUBLIC_SUPABASE_URL e NEXT_PUBLIC_SUPABASE_ANON_KEY no ambiente
  const SUPABASE_URL = (window.__env && window.__env.NEXT_PUBLIC_SUPABASE_URL) || 'YOUR_SUPABASE_URL';
  const SUPABASE_ANON_KEY = (window.__env && window.__env.NEXT_PUBLIC_SUPABASE_ANON_KEY) || 'YOUR_SUPABASE_ANON_KEY';

  // Valida√ß√£o m√≠nima
  if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
    console.warn('Substitua SUPABASE_URL e SUPABASE_ANON_KEY antes de usar.');
  }

  import('https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm').then(({ createClient }) => {
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { realtime: { params: { eventsPerSecond: 10 } } });

    // App state
    let currentUser = null;
    let profile = null;
    let editingMessageId = null;

    // DOM refs
    const authArea = document.getElementById('auth-area');
    const authCard = document.getElementById('auth-card');
    const createPost = document.getElementById('create-post');
    const feed = document.getElementById('feed');
    const postsList = document.getElementById('posts-list');
    const miniAvatar = document.getElementById('mini-avatar');
    const miniDisplay = document.getElementById('mini-display');
    const miniUsername = document.getElementById('mini-username');
    const btnEditProfile = document.getElementById('btn-edit-profile');
    const btnLogout = document.getElementById('btn-logout');
    const profilePage = document.getElementById('profile-page');
    const profileEdit = document.getElementById('profile-edit');
    const chatPage = document.getElementById('chat-page');
    const chatList = document.getElementById('chat-list');
    const notificationsEl = document.getElementById('notif-list');
    const postPage = document.getElementById('post-page');

    // helpers
    function el(tag, attrs={}, text='') {
      const e = document.createElement(tag);
      for (const k in attrs) {
        if (k === 'onclick') e.onclick = attrs[k];
        else e.setAttribute(k, attrs[k]);
      }
      if (text) e.textContent = text;
      return e;
    }
    function show(id) { id.style.display = ''; }
    function hide(id) { id.style.display = 'none'; }
    function fmtDate(d){ return new Date(d).toLocaleString(); }

    // Auth handlers
    document.getElementById('btn-show-register').onclick = () => {
      hide(document.getElementById('login-form'));
      show(document.getElementById('register-form'));
    };
    document.getElementById('btn-cancel-register').onclick = () => {
      show(document.getElementById('login-form'));
      hide(document.getElementById('register-form'));
    };
    document.getElementById('btn-register').onclick = async () => {
      const email = document.getElementById('reg-email').value;
      const pass = document.getElementById('reg-password').value;
      const pass2 = document.getElementById('reg-password2').value;
      const display = document.getElementById('reg-display').value || '';
      const username = (document.getElementById('reg-username').value || '').replace(/^@/,'').toLowerCase();

      if (!email || !pass || pass !== pass2) return alert('Verifique email e senhas (iguais).');
      // cria usu√°rio no supabase auth
      const { user, error } = await supabase.auth.signUp({ email, password: pass });
      if (error) return alert('Erro ao criar conta: '+error.message);
      // cria registro na tabela profiles (ser√° criado via trigger se preferir)
      // armazenamos display e username no perfil depois do login/confirm
      alert('Conta criada. Confira seu email para confirma√ß√£o se estiver habilitado. Fa√ßa login.');
    };

    document.getElementById('btn-login').onclick = async () => {
      const email = document.getElementById('login-email').value;
      const pass = document.getElementById('login-password').value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password: pass });
      if (error) return alert('Erro login: '+error.message);
      currentUser = data.user;
      await ensureProfileExists();
      await initApp();
    };

    document.getElementById('btn-send-recover').onclick = async () => {
      const email = document.getElementById('rec-email').value;
      const { data, error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: window.location.href });
      if (error) return alert('Erro: '+error.message);
      alert('Email de recupera√ß√£o enviado.');
    };
    document.getElementById('btn-cancel-recover').onclick = () => { show(document.getElementById('login-form')); hide(document.getElementById('recover-form')); };
    document.getElementById('btn-recover').onclick = () => { hide(document.getElementById('login-form')); show(document.getElementById('recover-form')); };

    // Logout
    document.getElementById('btn-logout').onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    // Ensure profile exists
    async function ensureProfileExists(){
      const session = supabase.auth.getSession().then(r=>r.data.session).catch(()=>null);
      const s = await session;
      if (!s) return;
      currentUser = s.user;
      const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single().maybeSingle();
      if (!data) {
        // create empty profile with defaults; username must be unique, fallback to user id
        const defaultusername = (currentUser.email || currentUser.id).split('@')[0].replace(/[^a-z0-9]/gi,'').toLowerCase().slice(0,20);
        await supabase.from('profiles').insert([{ id: currentUser.id, display_name: currentUser.user_metadata?.full_name || defaultusername, username: defaultusername }]);
      }
    }

    // Init on load if already logged in
    supabase.auth.onAuthStateChange((event, session) => {
      if (session && session.user) {
        currentUser = session.user;
        ensureProfileExists().then(initApp);
      } else {
        currentUser = null;
      }
    });

    async function initApp(){
      // load profile
      const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
      profile = data;
      renderAuthArea();
      renderMiniProfile();
      show(createPost);
      hide(authCard);
      loadFeed();
      subscribeRealtime();
      loadNotifications();
      loadChatList();
    }

    function renderAuthArea(){
      authArea.innerHTML = '';
      const p = el('div',{}, '');
      const a = el('span',{}, profile.display_name || 'Voc√™');
      p.appendChild(a);
      const small = el('div',{class:'small'}, '');
      small.textContent = profile.username ? '@'+profile.username : '';
      p.appendChild(small);
      authArea.appendChild(p);
    }

    function renderMiniProfile(){
      miniAvatar.src = profile.avatar_url || 'https://via.placeholder.com/48';
      miniDisplay.textContent = profile.display_name || '';
      miniUsername.textContent = profile.username ? '@'+profile.username : '';
    }

    // Profile edit
    btnEditProfile.onclick = () => {
      show(profileEdit);
      document.getElementById('edit-display').value = profile.display_name || '';
      document.getElementById('edit-username').value = profile.username || '';
      document.getElementById('edit-location').value = profile.location || '';
      document.getElementById('edit-contact').value = profile.contact || '';
      document.getElementById('edit-education').value = profile.education || '';
      document.getElementById('edit-bio').value = profile.bio || '';
      document.getElementById('edit-lang').value = profile.lang_pref || 'pt';
    };
    document.getElementById('btn-save-profile').onclick = async () => {
      const display = document.getElementById('edit-display').value;
      const username = (document.getElementById('edit-username').value || '').replace(/^@/,'').toLowerCase();
      // check unique username
      const uniqueCheck = await supabase.from('profiles').select('id').eq('username', username).maybeSingle();
      if (uniqueCheck.data && uniqueCheck.data.id !== profile.id) return alert('Nome de usu√°rio j√° em uso');
      // upload avatar if any
      const avatarFile = document.getElementById('edit-avatar').files[0];
      let avatar_url = profile.avatar_url;
      if (avatarFile) {
        const fname = `avatars/${profile.id}/${Date.now()}_${avatarFile.name}`;
        const { data:up, error:err } = await supabase.storage.from('avatars').upload(fname, avatarFile, { upsert: false });
        if (err) console.warn('Erro upload ava
